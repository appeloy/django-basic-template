{%extends "index/base.html"%}

{%block content%}
{% for post in posts%}
<article class="media content-section">
  <img class = "rounded-circle article-img" src="{{post.author.profile.image.url}}">
    <div class="media-body">
      <div class="article-metadata">
        <a class="mr-2" href="#">{{ post.author }}</a>
        <small class="text-muted">{{ post.date_posted | date:"F d, Y"}}</small>
      </div>
      <h2><a class="article-title" href="{% url 'post-detail' post.id %}">{{ post.title }}</a></h2>
      <div class="content-wrapper">
        <p class="article-content">{{ post.content }}</p>
        <div class="text-center load-selector">...</div>
      </div>
      
    </div>
  </article>
{% endfor %}

<div class="contents">

</div>

{% if is_paginated %}
  {% if page_obj.has_previous%}
  <a class="btn btn-outline-info mb-4" href="?page={{page_obj.number|add:'-1'}}">previous</a>
  {%endif%}
  {% for num in page_obj.paginator.page_range%}
    {% if page_obj.number == num %}
    <a class="btn btn-info mb-4" href="?page={{num}}">{{num}}</a>
    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3'%}
    <a class="btn btn-outline-info mb-4" href="?page={{num}}">{{num}} </a>
    {%endif%}
  {%endfor%}
  {% if page_obj.has_next%}
  <a class="btn btn-outline-info mb-4" href="?page={{page_obj.number|add:'1'}}">next</a>
  {%endif%}
{%endif%}

<script>
  const articles = document.querySelectorAll(".content-wrapper");
  articles.forEach(a => {
    // console.log(a.offsetHeight)
    if (a.offsetHeight > 400){
      // console.log(a.childNodes)
      const article = a.childNodes[1];
      const content_loader = a.childNodes[3];
      article.classList.add("wrap-content");
      content_loader.classList.add("loader-show");
    }
  })

  const renderData = async (data) => {
    const {author_pic, author, title, content} = data;
    const article = document.createElement("article");
    article.classList.add("media");
    article.classList.add("content-section");
    article.innerHTML = `
    <img class = "rounded-circle article-img" src="${author_pic}">
    <div class="media-body">
      <div class="article-metadata">
        <a class="mr-2" href="#">${author}</a>
        <small class="text-muted">date</small>
      </div>
      <h2><a class="article-title" href="">${title }</a></h2>
      <div class="content-wrapper">
        <p class="article-content">${content }</p>
        <div class="text-center load-selector">...</div>
      </div>
    </div>
    `
    document.querySelector(".contents").appendChild(article)
  }

  const fetchData = async (page) => {
      const req = await fetch("http://localhost:8000/post/api/posts");
      const res = await req.json();
      console.log(res);
      // res.data.forEach(d => renderData(d));
  }

    fetchData(1);
    window.addEventListener("scroll", ()=>{
      const {scrollTop, scrollHeight, clientHeight} = document.documentElement;
      console.log(scrollTop, scrollHeight, clientHeight);
      if (scrollTop === scrollHeight - clientHeight){  //end of screen
        console.log("end")
      }
    })

    document.querySelectorAll(".load-selector.loader-show").forEach((l) => {
        console.log("xxx",l);
        l.addEventListener("click", (e) => {
            console.log(e.target)
            e.target.parentElement.childNodes[1].style.height = "fit-content";
            e.target.parentElement.childNodes[3].classList.remove("loader-show");
        })
      })

</script>
{%endblock%}
